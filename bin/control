#!/bin/bash

source $OPENSHIFT_CARTRIDGE_SDK_BASH

function is_running() {
  if [ ! -z "$(ps -ef | grep 'mongod' | grep -v grep)" ]; then
    return 0
  else
    return 1
  fi
}

function _repair_mongod() {
    authopts=$1
    if is_running ; then
        echo "Attempting to repair MongoDB ..."
        
        echo "use admin
            db.createUser({ user: \"admin\", pwd: \"${password}\", roles: [ \"readWrite\", \"dbAdmin\" ] })
            db.auth(\"admin\", \"${password}\")
            db.system.users.find()
            use $OPENSHIFT_APP_NAME
            db.openshift.save({application: \"$OPENSHIFT_APP_NAME\", dbhost: \"$OPENSHIFT_MONGODB_DB_HOST\" })
            db.createUser({ user: \"admin\", pwd: \"${password}\", roles: [ { role: \"readWrite\", db: \"$OPENSHIFT_APP_NAME\" }, \"readWrite\", \"dbAdmin\" ] })
            exit      
        " | ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongo
        rm -f /tmp/.dbshell
        
    else
        echo "MongoDB already running - not running repair"
    fi
}

function mongo_client() {
  url="${OPENSHIFT_MONGODB_DB_HOST}:${OPENSHIFT_MONGODB_DB_PORT}/admin"
  auth="-u ${OPENSHIFT_MONGODB_DB_USERNAME} -p ${OPENSHIFT_MONGODB_DB_PASSWORD}"
  ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongo $url $auth
}

function _wait_for_mongod_to_startup() {
    i=0
    while (! echo "exit" | mongo_client > /dev/null 2>&1) \
             && [ $i -lt 60 ]; do
        echo "Waiting for mongo to start..."
        sleep 1
        i=$(($i + 1))
    done
}

function _start_mongod() {
    authopts=${1:-"--auth"}
    nohup ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongod ${authopts} \
        --nounixsocket                                \
        --storageEngine wiredTiger                    \
        --dbpath ${OPENSHIFT_DATA_DIR}.mongodb/data   \
        --quiet                                       \
        --logRotate reopen                            \
        --logappend                                   \
       |& /usr/bin/logshifter -tag mongodb &
    _wait_for_mongod_to_startup
    if ! is_running; then
       nohup ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongod \
                --nounixsocket                                \
                --dbpath ${OPENSHIFT_DATA_DIR}.mongodb/data   \
                --storageEngine wiredTiger                    \
                --logRotate reopen                            \
                --logappend                                   \
       |& /usr/bin/logshifter -tag mongodb &
       
       sleep 1
        
       _repair_mongod "$authopts"
       _wait_for_mongod_to_startup
    fi
}

function start_mongo() {
    if ! is_running
    then
        echo "Starting MongoDB cartridge"
        _start_mongod  "$1"

        while ! is_running && [ $i -lt 60 ]; do
            sleep 1
            i=$(($i + 1))
            _repair_mongod "$authopts"
        done
        
        if ! is_running; then
          client_error "Failed to start MongoDB"
          exit 1
        fi
    else
        echo "MongoDB already running"
    fi
}

bin_mongo=${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongod
conf_mongo=${OPENSHIFT_MONGODB_DIR}conf/mongodb.conf

function start() {
  if is_running; then
    client_result 'MongoDB is already running.'
  else
    client_message 'Starting MongoDB ...'
    authopts=${1:-"--auth"}
    nohup ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongod \
        $authopts                                     \
        --nounixsocket                                \
        --storageEngine wiredTiger                    \
        --bind_ip $OPENSHIFT_MONGODB_IP                     \
        --config ${OPENSHIFT_MONGODB_DIR}conf/mongodb.conf  \
      |& /usr/bin/logshifter -tag mongodb &
      
    i=0
    while ! is_running && [ $i -lt 60 ]; do
      sleep 10
      i=$(($i + 1))
    done
    if is_running; then
      client_result 'MongoDB started.'
    else
      client_result 'Warning! Could not start MongoDB!'
      exit 1
    fi
  fi
}

function stop() {
  if ! is_running; then
      client_result 'MongoDB is already stopped.'
  else
    client_message 'Stopping MongoDB...'
    kill "$(ps -ef | grep 'mongod ' | grep -v grep | awk '{ print $2 }')" > /dev/null 2>&1
    i=0
    while is_running && [ $i -lt 60 ]; do
      sleep 1
      i=$(($i + 1))
    done
    if is_running; then
      client_result 'Warning! Could not stop MongoDB!'
      exit 1
    else
      client_result 'MongoDB stopped.'
    fi
  fi
}

function restart() {
  stop
  start
}

function status() {
  if is_running; then
    client_result 'MongoDB appears to be running.'
  else
    client_result 'MongoDB appears to be stopped.'
  fi
}

function tidy() {
  shopt -s dotglob
  client_message "Emptying logs in ${OPENSHIFT_LOG_DIR}..."
  rm -rf ${OPENSHIFT_LOG_DIR}/*.log*
  client_message 'Done.'
}

case ${1} in
  start)   start_mongo   ;;
  stop)    stop    ;;
  restart) restart ;;
  status)  status  ;;
  tidy)    tidy    ;;
  *)       exit 0
esac
