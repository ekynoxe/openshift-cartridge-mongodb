#!/bin/bash 

source $OPENSHIFT_CARTRIDGE_SDK_BASH

client_message 'POST INSTALL'
client_message 'DATA ${OPENSHIFT_DATA_DIR}.mongodb/data'
client_message 'IP $OPENSHIFT_MONGODB_IP'

password=$OPENSHIFT_MONGODB_DB_PASSWORD
url="${OPENSHIFT_MONGODB_DB_HOST}:${OPENSHIFT_MONGODB_DB_PORT}"

kill "$(ps -ef | grep 'mongod ' | grep -v grep | awk '{ print $2 }')" > /dev/null 2>&1

sleep 1

nohup ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongod \
        --nounixsocket                                \
        --logRotate reopen                            \
        --logappend                                   \
        --storageEngine wiredTiger                    \
        --bind_ip $OPENSHIFT_MONGODB_DB_HOST          \
        |& /usr/bin/logshifter -tag mongodb &

sleep 2
     
echo "use admin
      db.createUser({ user: \"admin\", pwd: \"${password}\", roles: [ \"readWrite\", \"dbAdmin\" ] })
      db.auth(\"admin\", \"${password}\")
      db.system.users.find()
      use $OPENSHIFT_APP_NAME
      db.openshift.save({application: \"$OPENSHIFT_APP_NAME\", dbhost: \"$OPENSHIFT_MONGODB_DB_HOST\" })
      db.createUser({ user: \"admin\", pwd: \"${password}\", roles: [ { role: \"readWrite\", db: \"$OPENSHIFT_APP_NAME\" }, \"readWrite\", \"dbAdmin\" ] })
      exit      
      " | ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongo $url
      
rm -f /tmp/.dbshell

kill "$(ps -ef | grep 'mongod ' | grep -v grep | awk '{ print $2 }')" > /dev/null 2>&1
sleep 2
kill "$(ps -ef | grep 'mongod ' | grep -v grep | awk '{ print $2 }')" > /dev/null 2>&1

cart_props "connection_url=mongodb://${OPENSHIFT_MONGODB_DB_HOST}:${OPENSHIFT_MONGODB_DB_PORT}"
cart_props "username=admin"
cart_props "password=${password}"
cart_props "database_name=$OPENSHIFT_APP_NAME"

client_message 'END POST INSTALL'
