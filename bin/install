#!/bin/bash

source $OPENSHIFT_CARTRIDGE_SDK_BASH

client_message 'INSTALL'

if [[ "${OPENSHIFT_APP_NAME}" =~ ^[0-9] ]]; then
  client_error ""
  client_error "Unable to add MongoDB cartridge to your application because"
  client_error "your application name (${OPENSHIFT_APP_NAME}) starts with number."
  client_error ""
  client_error "ERROR: MongoDB databases cannot start with number character."
  client_error ""
  exit 137
fi

# Download
#client_message 'DOWNLOADING ...'
curl -L -o ${OPENSHIFT_DATA_DIR}tmp.tgz http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-${2}.tgz

# Create bin directory if necessary
mkdir -p ${OPENSHIFT_MONGODB_DIR}.mongodb/bin

# Copy just the mongod binary
tar -xvzf ${OPENSHIFT_DATA_DIR}tmp.tgz --strip-components=1 -C ${OPENSHIFT_MONGODB_DIR}.mongodb mongodb-linux-x86_64-${2}/bin/mongod
tar -xvzf ${OPENSHIFT_DATA_DIR}tmp.tgz --strip-components=1 -C ${OPENSHIFT_MONGODB_DIR}.mongodb mongodb-linux-x86_64-${2}/bin/mongo

# Remove downloaded archive
rm ${OPENSHIFT_DATA_DIR}tmp.tgz

# Create data directory if necessary
mkdir -p ${OPENSHIFT_MONGODB_DIR}.mongodb/data

# install premade journal
mkdir -p $OPENSHIFT_MONGODB_DIR/data
if [ -e $OPENSHIFT_MONGODB_DIR/usr/journal-cache/journal.tar.gz ]; then
    echo 'Unpacking premade journal'
    tar -C $OPENSHIFT_MONGODB_DIR/data -xzf $OPENSHIFT_MONGODB_DIR/usr/journal-cache/journal.tar.gz
fi

# generate password and setup env vars
echo 'Generating username and password'
client_message 'Generating username and password'

# Generate password
# date +%s | sha256sum | base64 | head -c 64 ; echo
#password = date +%s | sha256sum | base64 | head -c 64
password=$(generate_password)

echo "admin" > $OPENSHIFT_MONGODB_DIR/env/OPENSHIFT_MONGODB_DB_USERNAME
echo "$password" > $OPENSHIFT_MONGODB_DIR/env/OPENSHIFT_MONGODB_DB_PASSWORD
echo "mongodb://admin:$password@${OPENSHIFT_MONGODB_DB_HOST}:${OPENSHIFT_MONGODB_DB_PORT}/" > $OPENSHIFT_MONGODB_DIR/env/OPENSHIFT_MONGODB_DB_URL

client_message $password

client_result ""
client_result "MongoDB ${version} database added.  Please make note of these credentials:"
client_result ""
client_result "   Root User:     admin"
client_result "   Root Password: $password"
client_result "   Database Name: $OPENSHIFT_APP_NAME"
client_result ""
client_result "Connection URL: mongodb://$OPENSHIFT_MONGODB_DB_HOST:$OPENSHIFT_MONGODB_DB_PORT/"

client_message 'END INSTALL'


nohup ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongod \
        --nounixsocket                                \
        --storageEngine wiredTiger                    \
        --dbpath ${OPENSHIFT_DATA_DIR}.mongodb/data   \
        --quiet                                       \
        --logRotate reopen                            \
        --logappend                                   \
      |& /usr/bin/logshifter -tag mongodb &


client_message 'POST INSTALL'

password=$OPENSHIFT_MONGODB_DB_PASSWORD
url="${OPENSHIFT_MONGODB_DB_HOST}:${OPENSHIFT_MONGODB_DB_PORT}/admin"

echo "use admin
      db.createUser({ user: \"admin\", pwd: \"${password}\", roles: [ \"readWrite\", \"dbAdmin\" ] })
      db.auth(\"admin\", \"${password}\")
      db.system.users.find()
      use $OPENSHIFT_APP_NAME
      db.openshift.save({application: \"$OPENSHIFT_APP_NAME\", dbhost: \"$OPENSHIFT_MONGODB_DB_HOST\" })
      db.createUser({ user: \"admin\", pwd: \"${password}\", roles: [ { role: \"readWrite\", db: \"$OPENSHIFT_APP_NAME\" }, \"readWrite\", \"dbAdmin\" ] })
      exit      
      " | ${OPENSHIFT_MONGODB_DIR}.mongodb/bin/mongo 
rm -f /tmp/.dbshell


cart_props "connection_url=mongodb://\$OPENSHIFT_MONGODB_DB_HOST:\$OPENSHIFT_MONGODB_DB_PORT/"
cart_props "username=admin"
cart_props "password=${password}"
cart_props "database_name=$OPENSHIFT_APP_NAME"

client_message 'END POST INSTALL'

kill "$(ps -ef | grep 'mongod ' | grep -v grep | awk '{ print $2 }')" > /dev/null 2>&1
